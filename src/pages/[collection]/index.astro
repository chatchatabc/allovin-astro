---
import MainLayout from "@layouts/MainLayout.astro";
import collectionsJson from "@data/collections.json";
import CollectionLayout from "@layouts/CollectionLayout.svelte";
import CardSelection from "@components/CardSelection.astro";
import { utilOptimizeColorVariants } from "../../domain/services/utilService";
import { productGetDetails } from "src/domain/services/productService";

export function getStaticPaths() {
  const collections = collectionsJson.contents;
  return collections.map((collection) => {
    return {
      params: {
        collection: collection.slug,
      },
      props: {
        collection,
      },
    };
  });
}

interface Props {
  collection: {
    title: string;
    slug: string;
    productShopifyIds: string[];
  };
}

const { collection } = Astro.props as Props;

const products = collection.productShopifyIds.map((productShopifyId) => {
  const newProduct = productGetDetails({ shopifyId: productShopifyId });
  return newProduct;
});

const productsFiltered = products.filter((product) => product !== null);
---

<MainLayout pageTitle={collection.title}>
  <ul data-card-deck class="w-full hidden flex-wrap pb-8">
    {
      [...productsFiltered].map((product) => {
        const images = product?.images ?? product?.shopify?.images.nodes ?? [];
        const image = images
          ? images[images.length - 1]
          : product?.featuredImage;

        return (
          <li
            class="cards flex-shrink-0 px-2 w-1/2 py-4  md:w-1/3 lg:w-1/4"
            data-id={product?.shopifyId}
          >
            <CardSelection
              name={product?.title ?? ""}
              price={product?.price ?? 0}
              secondaryImage={image?.url ?? "/images/placeholder.png"}
              variants={utilOptimizeColorVariants(
                product?.variants ?? product?.shopify?.variants.nodes ?? []
              )}
              href={`/products/${product?.slug}`}
            />
          </li>
        );
      })
    }
  </ul>
  <CollectionLayout
    name={collection.title}
    products={productsFiltered}
    client:only="svelte"
  >
    <ul data-card-container class="w-full flex flex-wrap pb-8"></ul>
  </CollectionLayout>
</MainLayout>
