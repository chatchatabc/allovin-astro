---
import Container from "@layouts/Container.astro";
import { Img } from "astro-imagetools/components";
import XIcon from "@assets/XIcon.astro";
import MagnifyIcon from "@assets/MagnifyIcon.astro";
import NavbarSearchResults from "./NavbarSearchResults.svelte";
import productsJson from "@data/products.json";
import { productGetShopifyDetails } from "src/domain/services/productService";
import type { Product } from "src/domain/models/productModel";

const products: Product[] = productsJson.filter((product) => product.show);

const navigations = [
  {
    name: "MOMMY & ME",
    href: "/mommy-and-me",
  },
  {
    name: "GIRLS",
    href: "/girls",
  },
  {
    name: "BOYS",
    href: "/boys",
  },
  {
    name: "WOMEN",
    href: "/women",
  },
  {
    name: "EXCLUSIVES",
    href: "/exclusives",
  },
  {
    name: "ACCESORIES",
    href: "/accessories",
  },
  {
    name: "SHOP ALL",
    href: "/shop-all",
  },
  {
    name: "OUR STORY",
    href: "/our-story",
  },
];
---

<header class="sticky bg-white z-[1000] top-0 shadow-md">
  <!-- Navbar -->
  <Container className="py-2 lg:py-4">
    <!-- Top -->
    <section
      class="flex relative justify-between items-center lg:justify-center"
    >
      <!-- Menu Button for Mobile -->
      <button
        aria-label="Mobile Menu Open Button"
        data-menu-btn
        class="space-y-1 lg:hidden"
      >
        <div data-menu-burger class="w-8 h-1 rounded-full bg-c1"></div>
        <div data-menu-burger class="w-8 h-1 rounded-full bg-c1"></div>
        <div data-menu-burger class="w-8 h-1 rounded-full bg-c1"></div>
      </button>

      <!-- Centered Logo -->
      <a href="/" class="flex relative z-[2] items-start space-x-2">
        <div class="w-36 lg:w-40">
          <Img src="/images/logo.webp" alt="allovin" />
        </div>
        <div
          class="px-0.5 border-c1 text-c1 border-2 font-bold rounded-sm text-xs"
        >
          PH
        </div>
      </a>

      <!-- Search Inputs -->
      <div
        class="right-0 top-1/2 flex lg:-translate-y-1/2 lg:justify-end lg:absolute"
      >
        <!-- Mobile Input -->
        <div class="lg:hidden">
          <!-- Button -->
          <button aria-label="mobile-search-open-button" data-search-open-btn>
            <div class="w-6 h-6">
              <MagnifyIcon />
            </div>
          </button>

          <!-- Background when mobile input is open -->
          <div
            data-search-bg
            class="hidden fixed z-[2] h-full w-full bg-black opacity-50 left-0 top-0"
          >
          </div>

          <!-- Input -->
          <div
            data-search-input
            class="hidden z-[3] absolute top-full w-full right-0"
          >
            <input
              value=""
              data-search-input
              placeholder="Search"
              class="p-2 border w-full"
            />
          </div>
        </div>

        <!-- Desktop Input -->
        <div class="hidden space-x-4 lg:block">
          <div class="relative">
            <input
              value=""
              data-search-input
              class="border p-2 font-light text-sm w-56"
              placeholder="Search"
            />
            <div
              class="w-6 h-6 pointer-events-none absolute right-2 top-1/2 -translate-y-1/2"
            >
              <MagnifyIcon />
            </div>
          </div>
        </div>
      </div>

      <!-- Search Results -->
      <div
        data-search-results
        class="absolute z-[3] border bg-white top-full right-0 w-full shadow-xl hidden mt-12 lg:mt-2 lg:max-w-2xl"
      >
        <ul data-navbar-card-deck class="hidden flex-nowrap overflow-hidden">
          {
            products.map((product) => {
              const shopifyData = productGetShopifyDetails({
                shopifyId: product.shopifyId,
              });

              return (
                <li
                  data-navbar-card={product.shopifyId}
                  class="w-1/2 shrink-0 p-2 md:w-1/3"
                >
                  <a href={`/products/${product.slug}`}>
                    <figure>
                      <div>
                        {(product.featuredImage?.url ??
                          shopifyData?.featuredImage?.url) && (
                          <Img
                            breakpoints={[320]}
                            src={
                              product.featuredImage?.url ??
                              shopifyData?.featuredImage?.url
                            }
                            alt={product.title}
                          />
                        )}
                      </div>
                      <figcaption class="text-gray-500">
                        <p class="line-clamp-2">{product.title}</p>
                        <p class="text-p500">
                          {new Intl.NumberFormat("en", {
                            style: "currency",
                            currency: "PHP",
                          }).format(product.price ?? 0)}
                        </p>
                      </figcaption>
                    </figure>
                  </a>
                </li>
              );
            })
          }
        </ul>
        <NavbarSearchResults client:idle />
      </div>
    </section>

    <!-- Desktop Navigations -->
    <nav class="hidden mt-4 lg:block">
      <ul class="flex justify-center space-x-8">
        {
          navigations.map((link) => {
            return (
              <li class="relative">
                <a class="text-c1 text-lg font-light peer" href={link.href}>
                  {link.name}
                </a>
                <div class="absolute scale-x-0 w-full h-[0.1rem] origin-bottom-left transition bottom-0 bg-c1 peer-hover:scale-x-100" />
              </li>
            );
          })
        }
      </ul>
    </nav>
  </Container>

  <!-- Mobile Nav Menu -->
  <section
    data-mobile-menu
    class="fixed top-0 left-0 w-full h-full backdrop-blur-sm opacity-0 pointer-events-none transition"
  >
    <!-- Background -->
    <section
      data-mobile-menu-bg
      class="bg-black absolute w-full h-full opacity-50"
    >
    </section>

    <!-- Content -->
    <nav
      data-mobile-menu-nav
      class="w-full bg-white absolute h-full -translate-x-full transition md:w-96"
    >
      <ul class="flex flex-col justify-center items-center h-full py-16">
        {
          navigations.map((link) => {
            return (
              <li class="relative">
                <a class="text-c1 text-lg font-light peer" href={link.href}>
                  {link.name}
                </a>
                <div class="absolute scale-x-0 w-full h-[0.1rem] origin-bottom-left transition bottom-0 bg-c1 peer-hover:scale-x-100" />
              </li>
            );
          })
        }
        <li class="mt-auto">
          <button
            aria-label="Mobile Menu Close Button"
            data-menu-close-btn
            class="p-2 text-white bg-red-600 rounded-full"
          >
            <div class="w-8 h-8">
              <XIcon />
            </div>
          </button>
        </li>
      </ul>
    </nav>
  </section>
</header>

<script>
  const menuBtn = document.querySelector("[data-menu-btn]")!;
  const menuCloseBtn = document.querySelector("[data-menu-close-btn]")!;
  const mobileMenu = document.querySelector("[data-mobile-menu]")!;
  const mobileMenuBg = document.querySelector("[data-mobile-menu-bg]")!;
  const mobileMenuNav = document.querySelector("[data-mobile-menu-nav]")!;

  const searchMobileBg = document.querySelector("[data-search-bg]")!;
  const searchOpenBtn = document.querySelector("[data-search-open-btn]")!;
  const searchResults = document.querySelector("[data-search-results]")!;
  const searchInputs = document.querySelectorAll<HTMLInputElement>(
    "[data-search-input]"
  )!;

  // Mobile search
  searchOpenBtn.addEventListener("click", () => {
    searchMobileBg.classList.remove("hidden");
    searchInputs.forEach((input) => {
      input.classList.remove("hidden");
    });
  });
  searchMobileBg.addEventListener("click", () => {
    searchMobileBg.classList.add("hidden");
    searchInputs.forEach((input) => {
      input.classList.add("hidden");
    });
  });

  // Search inputs
  searchInputs.forEach((input) => {
    input.addEventListener("focus", () => {
      searchResults.classList.remove("hidden");
    });

    input.addEventListener("blur", () => {
      // if mouse is on search results, it won't hide
      if (!searchResults.matches(":hover")) {
        searchResults.classList.add("hidden");
      }
    });

    input.addEventListener("keyup", (e) => {
      const value = (e.target as HTMLInputElement).value;

      searchInputs.forEach((input) => {
        input.value = value;
      });

      if (value.length > 0) {
        searchResults.classList.remove("hidden");
      } else {
        searchResults.classList.add("hidden");
      }
    });
  });

  searchResults.addEventListener("mouseleave", () => {
    if (searchInputs[0].value.length === 0) {
      searchResults.classList.add("hidden");
    }
  });

  function closeMobileMenu() {
    mobileMenu.classList.add("opacity-0");
    mobileMenu.classList.add("pointer-events-none");
    mobileMenuNav.classList.add("-translate-x-full");

    // enable body scrollbar
    document.body.style.overflow = "auto";
  }

  menuBtn.addEventListener("click", () => {
    mobileMenu.classList.remove("opacity-0");
    mobileMenu.classList.remove("pointer-events-none");
    mobileMenuNav.classList.remove("-translate-x-full");

    // disable body scrollbar
    document.body.style.overflow = "hidden";
  });

  mobileMenuBg.addEventListener("click", () => {
    closeMobileMenu();
  });

  menuCloseBtn.addEventListener("click", () => {
    closeMobileMenu();
  });
</script>
